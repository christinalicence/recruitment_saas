{% extends "cms/base_cms.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block content %}
<div class="py-4 bg-light">
    <div class="container-fluid px-4">
        <div class="row g-4">
            
            <div class="col-lg-5 col-xl-4">
                <div class="card bg-white shadow-sm editor-card d-flex flex-column" style="height: calc(100vh - 120px); border-radius: 12px; overflow: hidden;">
                    
                    <div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-white">
                        <div>
                            <a href="{% url 'cms:dashboard' %}" class="text-decoration-none small text-muted">&larr; Dashboard</a>
                            <h1 class="h5 mb-0 fw-bold">Site Editor</h1>
                        </div>
                        <button type="submit" form="editor-form" class="btn btn-primary btn-sm px-4 fw-bold shadow-sm">Save All</button>
                    </div>
                    <div class="editor-scroll-area p-4" style="flex-grow: 1; overflow-y: auto;">
                        <form method="post" enctype="multipart/form-data" id="editor-form">
                            {% csrf_token %}
                            <div class="editor-section mb-4 pt-3">
                                <h6 class="fw-bold text-uppercase small text-muted mb-3">Site Layout</h6>
                                <div class="mb-3">
                                    <label class="form-label fw-bold small">Choose Template</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white"><i class="bi bi-layout-sidebar-inset"></i></span>
                                        <select name="template_choice" id="id_template_choice" class="form-select shadow-sm">
                                            <option value="executive" {% if form.instance.template_choice == 'executive' %}selected{% endif %}>The Executive</option>
                                            <option value="startup" {% if form.instance.template_choice == 'startup' %}selected{% endif %}>The Startup</option>
                                            <option value="boutique" {% if form.instance.template_choice == 'boutique' %}selected{% endif %}>The Boutique</option>
                                        </select>
                                    </div>
                                    <small class="text-muted" style="font-size: 0.7rem;">Select a layout to instantly change your site's structure.</small>
                                </div>
                            </div>
                            <div class="editor-section mb-4">
                                <h6 class="fw-bold text-uppercase small text-muted mb-3">Branding & Colors</h6>
                                <div class="mb-3">{{ form.display_name|as_crispy_field }}</div>
                                
                                <label class="form-label fw-bold small">Company Logo</label>
                                <div class="upload-preview-card p-3 border rounded text-center mb-3">
                                    <div id="logo-preview-container" class="d-flex justify-content-center align-items-center mx-auto mb-2 rounded shadow-sm bg-light" style="width: 80px; height: 80px; overflow: hidden;">
                                        {% if form.instance.logo %}
                                            <img id="logo-preview" src="{{ form.instance.logo.url }}" class="img-fluid" style="max-height: 100%; object-fit: contain;">
                                        {% else %}
                                            <div id="logo-text-fallback" class="fw-bold text-primary h3 mb-0">
                                                {{ form.instance.display_name|default:"?"|slice:":1" }}
                                            </div>
                                            <img id="logo-preview" src="" class="img-fluid d-none" style="max-height: 100%; object-fit: contain;">
                                        {% endif %}
                                    </div>
                                    {{ form.logo|as_crispy_field }}
                                </div>

                                <div class="color-pickers">
                                    <div class="mb-2">{{ form.primary_color|as_crispy_field }}</div>
                                    <div class="mb-2">{{ form.secondary_color|as_crispy_field }}</div>
                                    <div class="mb-2">{{ form.background_color|as_crispy_field }}</div>
                                </div>
                                <div class="mt-3 p-3 bg-light rounded border">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="small fw-bold text-muted">Readability Check</span>
                                        <span id="contrast-status-badge" class="badge bg-success">Perfect</span>
                                    </div>
                                    <div class="progress mb-2" style="height: 6px;">
                                        <div id="contrast-bar" class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
                                    </div>
                                    <div class="d-flex flex-column gap-1">
                                        <small id="contrast-status-text" class="text-muted italic" style="font-size: 0.75rem;">
                                            Great! Very easy for candidates to read.
                                        </small>
                                        <small class="text-muted" style="font-size: 0.7rem;">
                                            Readability Score: <span id="contrast-ratio" class="fw-bold">1.0</span>
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <div class="editor-section mb-4 pt-3 border-top">
                                <h6 class="fw-bold text-uppercase small text-muted mb-3">Main Image & Intro</h6>
                                {{ form.hero_title|as_crispy_field }}
                                
                                <div class="d-flex justify-content-between align-items-end mb-1">
                                    <label class="form-label mb-0 fw-bold small">Hero Description</label>
                                    <small class="char-count text-muted" data-for="id_hero_text">0 / 200</small>
                                </div>
                                {{ form.hero_text|as_crispy_field }}

                                <label class="form-label fw-bold small">Main Background Image</label>
                                <div class="upload-preview-card p-3 border rounded mb-3">
                                    <div class="rounded mb-2 shadow-sm d-flex align-items-center justify-content-center text-white"
                                         style="height: 120px; width: 100%; background: linear-gradient(45deg, #1e3a8a, #3b82f6); overflow: hidden;">
                                         {% if form.instance.hero_image %}
                                            <img id="id_hero_image-preview" src="{{ form.instance.hero_image.url }}" style="width: 100%; height: 100%; object-fit: cover;">
                                         {% else %}
                                            <img id="id_hero_image-preview" src="" class="d-none" style="width: 100%; height: 100%; object-fit: cover;">
                                            <small id="hero-placeholder-text" class="opacity-50">No image selected</small>
                                         {% endif %}
                                    </div>
                                    {{ form.hero_image|as_crispy_field }}
                                </div>
                            </div>

                            <div class="editor-section mb-4 pt-3 border-top" data-section="about">
                                <h6 class="fw-bold text-uppercase small text-muted mb-3">About the Company</h6>
                                {{ form.about_title|as_crispy_field }}
                                {{ form.about_content|as_crispy_field }}

                                <label class="form-label fw-bold small">Team / About Photo</label>
                                <div class="upload-preview-card p-3 border rounded mb-3">
                                    <img id="team_photo-preview" 
                                         src="{% if form.instance.team_photo %}{{ form.instance.team_photo.url }}{% else %}https://placehold.co/600x300?text=About+Photo{% endif %}" 
                                         class="img-fluid mb-2 rounded shadow-sm" style="height: 120px; width: 100%; object-fit: cover;">
                                    {{ form.team_photo|as_crispy_field }}
                                </div>
                            </div>

                            <div class="editor-section mb-4 pt-3 border-top" data-section="jobs">
                                <h6 class="fw-bold text-uppercase small text-muted mb-3">Jobs Page</h6>
                                <div class="d-flex justify-content-between align-items-end mb-1">
                                    <label class="form-label mb-0 fw-bold small">Jobs Header Text</label>
                                    <small class="char-count text-muted" data-for="id_jobs_header_text">0 / 150</small>
                                </div>
                                {{ form.jobs_header_text|as_crispy_field }}
                            </div>

                            <div class="editor-section mb-4 pt-3 border-top">
                                <h6 class="fw-bold text-uppercase small text-muted mb-3">Contact Info</h6>
                                {{ form.contact_email|as_crispy_field }}
                                {{ form.contact_phone|as_crispy_field }}
                                {{ form.address|as_crispy_field }}
                                {{ form.linkedin_url|as_crispy_field }}
                            </div>

                        </form> </div>
                </div>
            </div>

            <div class="col-lg-7 col-xl-8">
                <div class="sticky-top" style="top: 20px;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold text-uppercase small text-muted mb-0">Live Preview</h6>
                        <div class="btn-group shadow-sm">
                            <button type="button" class="btn btn-outline-secondary btn-sm active" onclick="setPreviewSize('desktop')" id="btn-desktop">Desktop</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPreviewSize('tablet')" id="btn-tablet">Tablet</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPreviewSize('mobile')" id="btn-mobile">Mobile</button>
                        </div>
                    </div>
                    
                    <div id="preview-wrapper" class="preview-frame-wrapper desktop-mode mx-auto shadow-lg rounded border overflow-hidden">
                        <div class="ratio ratio-16x9">
                            <iframe src="{% url 'cms:live_preview' %}" id="preview-frame"></iframe>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div aria-live="polite" aria-atomic="true" class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 9999;">
    <div id="messageToast" class="toast align-items-center text-white border-0 shadow-lg" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body fw-bold" id="toastMessage"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'cms/js/contrast-checker.js' %}"></script>
<script src="{% static 'cms/js/preview-manager.js' %}"></script>
{% endblock %}